
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Steve Robinson</title>
  <meta name="author" content="Steve Robinson">

  
  <meta name="description" content="We were doing some crazy things with our staging server and it ran out of space which we did not notice because of the lack of monitoring on this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://steverobinson.in">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Steve Robinson" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Steve Robinson</a></h1>
  
    <h2>My life, code & random musings...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:steverobinson.in" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/11/lack-of-diskspace-makes-passenger-throw-rackrewindableinput-not-found/">RackRewindableInput Lock File Not Found</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-11T17:05:41+05:30" pubdate data-updated="true">Mar 11<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We were doing some crazy things with our staging server and it ran out of space which we did not notice because of the lack of monitoring on this instance. When our Q/A tried accessing the server later on the app was inaccessible and was throwing 500s all over.</p>

<p>The exception tracker we are using sent us the stacktrace and the error message was incredibly puzzling - <code>Errno::ENOENT: No such file or directory /tmp/RackRewindableInput20150311-13259-cvqkcr.lock)</code>. I was not sure what to make of this and I had no idea that we had ran out of space.</p>

<p>Using the stacktrace I figured out that the exception was thrown from a class - <code>RewindableInput</code> in the Passenger project. There was note saying this was a modified version of <code>Rack::RewindableInput</code>. So this is actually a part of the Rack codebase as well.</p>

<p>After doing some research I learned that this RewindableInput class is used to make a the request body <code>rewindable</code> which apparently means that you can bring it back to the original state whenever you want to (if I understand correctly).</p>

<p>The exception was thrown at <a href="https://github.com/phusion/passenger/blob/stable-3.0/lib/phusion_passenger/utils/rewindable_input.rb#L86">this line</a> where a <code>tempfile</code> is being created and since we did not have any space on the disk this could not happen and thus we got the error.</p>

<p>Even then, since the error message was <code>Errno::ENOENT: No such file or directory</code> and me being not aware of how <a href="https://www.omniref.com/ruby/2.2.1/symbols/Tempfile">Tempfile</a> works could not figure out that the reason was the diskspace. Then I ran into a StackOverflow answer where the OP had reported a similar problem with JRuby and the reccomended solution was the check if the <code>/tmp</code> directory is writable and has proper permissions. But the OP later reported that he had actually ran out of space.</p>

<p>Why did I not think of that? Anyway, I then ran <code>df</code> and found out the disk had no space left. I immediately cleared the junk that was created because of the <strong>crazy stuff</strong> I had been doing earlier and everything went back to normal.</p>

<p>So! If you ever come across this exception - <code>Errno::ENOENT: No such file or directory /tmp/RackRewindableInput&lt;timestamp&gt;-&lt;random&gt;.lock)</code> check your disk space first! :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/21/ruby-2-dot-0-boosts-rails-boot-time/">Ruby 2.0 Boosts Rails Boot Time</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-21T19:23:54+05:30" pubdate data-updated="true">Jan 21<sup>st</sup>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been working on a codebase which is Rails 4.0 and Ruby 1.9.3 and something that&rsquo;s annoying about this app is its incredibly large load time. It takes about 26 seconds to boot up.</p>

<p><code>bundle exec rake environment  22.22s user 1.14s system 91% cpu 25.632 total</code></p>

<p>Now we&rsquo;re not doing anything fancy during the bootup so I figured it must the gems that we are loading that&rsquo;s taking so much time.
While googling for ways to debug the boot time I came across this really cool gem called <a href="https://github.com/nevir/Bumbler">Bumbler</a> which prints out the load times for each and every gem in your app.</p>

<p>These are some of the gems that were taking lots of time to load.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>367.43  rails
</span><span class='line'>408.94  fuubar
</span><span class='line'>420.56  slim
</span><span class='line'>441.58  pry-rails
</span><span class='line'>488.60  activemerchant
</span><span class='line'>651.05  meta-tags
</span><span class='line'>986.72  axlsx
</span><span class='line'>1231.87  newrelic_rpm
</span><span class='line'>1303.99  geocoder
</span><span class='line'>2749.84  fog
</span><span class='line'>3044.00  carrierwave</span></code></pre></td></tr></table></div></figure>


<p>Its amazing that it takes 3 seconds to load carrierwave.
I double checked my initializers to make sure there&rsquo;s nothing that could slow down the loading and there was none.
So is Ruby&rsquo;s <code>require</code> slow?</p>

<p>To find out I did some digging and ended up at this <a href="https://bugs.ruby-lang.org/issues/7158">bug report</a> which talks about improvements to Ruby&rsquo;s <code>require</code> method.
It seems when requiring a file Ruby iterates through the <code>$LOAD_PATHS</code> array to see if the file is loaded which is extremely ineffecient if there are many files to load.
The patch made uses a hash to maintain the loaded files so that it can be looked up in O(1) time.
This is explained by Xavier Shay <a href="http://rhnh.net/2011/05/28/speeding-up-rails-startup-time">here</a>.</p>

<p>In addition to this the string objects in the arrays <code>$LOAD_PATHS</code> and <code>$LOADED_FEATURES</code> are also frozen so these can be cached.
Freezing strings makes them immutable. This is well explained in this <a href="http://magazine.rubyist.net/?Ruby200SpecialEn-require">other article</a> by <a href="https://twitter.com/taru">Masaya Tarui</a>, author of the patch.</p>

<p>All this has made Ruby 2.0 require files much faster. I temporarily switched to Ruby 2.2 and take a look at this -
<code>bundle exec rake environment  3.95s user 0.85s system 99% cpu 4.822 total</code>.</p>

<p>Bumbler report:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>102.74  countries
</span><span class='line'>103.72  haml-rails
</span><span class='line'>117.40  devise
</span><span class='line'>122.33  foundation-rails
</span><span class='line'>130.76  newrelic_rpm
</span><span class='line'>132.80  pry-rails
</span><span class='line'>144.39  sass-rails
</span><span class='line'>163.59  activemerchant
</span><span class='line'>169.82  rails
</span><span class='line'>195.35  axlsx
</span><span class='line'>261.47  geocoder
</span><span class='line'>632.77  fog
</span><span class='line'>780.72  carrierwave</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s a whopping 81% improvement over Ruby 1.9.3 in my case. Your mileage may vary. But this is amazing. So as soon as I get the chance I am going to upgrade to Ruby 2.2 :)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/30/your-own-geocoding-service/">Hosting FreeGeoIP in Your Cloud</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-30T21:11:02+05:30" pubdate data-updated="true">Nov 30<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the project I&rsquo;m working on where we sell photos, we had to find out the country of each and every visitor for a certain business purpose. So we have this piece of code in the Rails <code>ApplicationController</code> to do the job.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">set_country_currency</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:country</span><span class="o">]</span> <span class="o">||=</span> <span class="n">request</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">country</span>
</span><span class='line'>  <span class="k">rescue</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="s2">&quot;ip=</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="si">}</span><span class="s2"> exception_type=visitor_geocoding_failure&quot;</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:country</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;United States of America&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>location</code> method called on <code>request</code> is actually provided by this super awesome and popular Geocoding gem called <a href="https://github.com/alexreisner/geocoder">geocoder</a> and it returns the country from which the request originated. It figures this information out using the IP address available in the request object. Okay but how does the geocoder gem finds the country from an IP address? For doing that geocoder actually talks to an external service called <a href="http://freegeoip.net">FreeGeoIP</a> which is a service written in Go-lang. Btw, Geocoder supports many more such geocoding services like the ones provided by Google, MaxMind etc. FreeGeoIP is completely free and has a fairly reasonable rate-limit (10000 requests / hr). We deployed this part to production and it was working fine until I noticed some performance issues within couple of days.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/11/30/your-own-geocoding-service/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/31/outsourcing-image-processing/">Outsourcing Image Processing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-31T01:06:26+05:30" pubdate data-updated="true">Oct 31<sup>st</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of our clients at Spritle is a startup that sells photos taken at various events. The Rails app we have built and maintaining for them involves photographers uploading large numbers of photos (each photographer uploads around 500-1000 images per album and we have lots of photographers, albums &amp; events!) at a time and processing these images into three versions of different dimensions. One of these versions also needs a watermark to be placed on it. We had a very basic setup to do all this work but it was not good enough and subsequently we offloaded the heavyligting to a cloud service. But before that let me explain how we were doing things before offloading the processing.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/10/31/outsourcing-image-processing/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/23/on-foundations-validation-and-my-pull-request/">On Foundation&#8217;s Validation &amp; My Pull Request</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-23T02:51:42+05:30" pubdate data-updated="true">Sep 23<sup>rd</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We widely use the amazing <a href="http://foundation.zurb.com/">Zurb Foundation</a> framework as a base for many of our projects at work. Foundation provides a lot of features and utilities out of the box. One such useful feature is the JavaScript form validation library which they call <a href="http://foundation.zurb.com/docs/components/abide.html">Abide</a>.</p>

<p>Abide is powerful and also flexible. There are a lot of configuration options and it even allows us to easily add custom validations in addition to the ones it provides out of the box. Foundation Abide was working out fine for us until recently when a client of ours asked for a change in the way validation works in the app we do for them.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/09/23/on-foundations-validation-and-my-pull-request/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/10/a-fresh-start/">A Fresh Start</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-10T11:04:08+05:30" pubdate data-updated="true">Aug 10<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Its my birthday and I&rsquo;m turning 23 today. I&rsquo;ve been meaning to start a new blog (old one <a href="http://footyntech.wordpress.com">here</a>) for a while now and I&rsquo;ve finally taken that step today. I love blogging and I encourage people around me to do it but then for several months, interestingly right after I feel in love with Ruby and Rails I&rsquo;ve stopped writing completely. I do not know why that happened but it just happened. I wrote these <em>come back posts</em> whenever I felt inspired to write something and I promised I would resume blogging but I never did. And I really don&rsquo;t know if this new blog would be any different. But I hope it is.</p>

<p>Alright why am I starting a new blog? Well, I don&rsquo;t have a proper reason for that. Its like I just don&rsquo;t feel like writing anymore over there in my old blog. Whenever I go through the old stuff I wrote, for some reason, I feel it just does not reflect who I am now. Maybe it did when I wrote them but now I think I&rsquo;ve changed a lot. So I want to start afresh with this new blog.</p>

<p>I&rsquo;m Steve Robinson and I work as a technical consultant at <a href="http://sprite.com">Spritle Software</a>. I write code for a living and I write code as a hobby. Apart from software I&rsquo;m interested in football (not hand-egg), humanitarian causes, politics, aviation and computer science. I have a pet GSD and his name is <a href="http://instagram.com/p/ifq033MjsP">Jim</a> and like most programmers I know, I absolutely love coffee! I&rsquo;m a Protestant Christian and I live in a medium sized dusty town called Avadi near Chennai. This is my life :)</p>

<p>Oh and this blog is statically generated using <a href="http://octopress.org/">Octopress</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/11/lack-of-diskspace-makes-passenger-throw-rackrewindableinput-not-found/">RackRewindableInput Lock File Not Found</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/21/ruby-2-dot-0-boosts-rails-boot-time/">Ruby 2.0 Boosts Rails Boot Time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/30/your-own-geocoding-service/">Hosting FreeGeoIP in Your Cloud</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/31/outsourcing-image-processing/">Outsourcing Image Processing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/23/on-foundations-validation-and-my-pull-request/">On Foundation&#8217;s Validation &amp; My Pull Request</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Steve Robinson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
